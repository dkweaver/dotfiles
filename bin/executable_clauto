#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: clauto [-d <directory>] <prompt>"
  echo "Runs Claude headless with full permissions, then lets you review changes."
  exit 1
}

dir=""
while getopts "d:" opt; do
  case $opt in
    d) dir="$OPTARG" ;;
    *) usage ;;
  esac
done
shift $((OPTIND - 1))

[ $# -eq 0 ] && usage

prompt="$*"

if [ -n "$dir" ]; then
  cd "$dir"
fi

# Ensure we're in a git repo
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "Error: not inside a git repository"
  exit 1
fi

# Check for clean working tree
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Error: working tree has uncommitted changes. Please commit or stash first."
  exit 1
fi

echo "Running Claude..."
claude -p --dangerously-skip-permissions "$prompt"

# Check if Claude made any changes
if git diff --quiet && git diff --cached --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
  echo "No changes were made."
  exit 0
fi

echo ""
echo "=== Changes ==="
echo ""
git diff
git diff --cached
git ls-files --others --exclude-standard | while read -r f; do
  echo "new file: $f"
  echo "---"
  cat "$f"
  echo ""
done

echo ""
read -rp "Accept these changes? [y/n] " answer

if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
  echo "Reverting changes..."
  git checkout -- .
  git clean -fd
  echo "Changes removed."
  exit 0
fi

# Stage everything
git add -A

# Generate commit message with Claude
echo "Generating commit message..."
diff_output=$(git diff --cached)
commit_msg=$(claude -p "Write a concise git commit message (subject line + optional body) for these changes. Output ONLY the commit message, nothing else:\n\n$diff_output")

echo ""
echo "=== Commit Message ==="
echo "$commit_msg"
echo ""

git commit -m "$commit_msg"
echo "Committed."

echo ""
read -rp "Push to remote? [y/n] " push_answer

if [[ "$push_answer" == "y" || "$push_answer" == "Y" ]]; then
  branch=$(git branch --show-current)
  git push origin "$branch"
  echo "Pushed to origin/$branch."
else
  echo "Not pushed."
fi
