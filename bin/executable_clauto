#!/usr/bin/env bash
set -euo pipefail

export PATH="$HOME/.local/bin:$PATH"

usage() {
  echo "Usage: clauto [-d <directory>] <prompt>"
  echo "Runs Claude headless with full permissions, then lets you review changes."
  exit 1
}

dir=""
while getopts "d:" opt; do
  case $opt in
    d) dir="$OPTARG" ;;
    *) usage ;;
  esac
done
shift $((OPTIND - 1))

if [ $# -eq 0 ]; then
  read -rp "Prompt: " prompt
  [ -z "$prompt" ] && echo "No prompt provided." && exit 1
else
  prompt="$*"
fi

if [ -n "$dir" ]; then
  cd "$dir"
else
  # No dir supplied â€” let user pick with zoxide
  if command -v zoxide &>/dev/null; then
    dir=$(zoxide query -i) || exit 1
    cd "$dir"
  else
    echo "Error: no directory supplied and zoxide not installed"
    exit 1
  fi
fi

# Ensure we're in a git repo
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "Error: not inside a git repository"
  exit 1
fi

# Check for clean working tree
if ! git diff --quiet || ! git diff --cached --quiet; then
  echo "Error: working tree has uncommitted changes. Please commit or stash first."
  exit 1
fi

MAX_CHANGED_FILES=10
repo_root=$(git rev-parse --show-toplevel)

guardrails="IMPORTANT RULES - you MUST follow these:
- ONLY edit files inside this repo: $repo_root
- Do NOT create or edit files outside the repo
- Do NOT edit .gitignore'd files or .env files
- Do NOT edit .git/ internals
- Do NOT delete files unless explicitly asked
- Do NOT install packages or run destructive commands
- Do NOT modify CI/CD pipelines or GitHub Actions
- Keep changes minimal and focused on the request"

echo "Running Claude..."
claude -p --dangerously-skip-permissions --model sonnet "$guardrails

User request: $prompt"

# Check if Claude made any changes
if git diff --quiet && git diff --cached --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
  echo "No changes were made."
  exit 0
fi

# Check number of changed files
changed_count=$(( $(git diff --name-only | wc -l) + $(git ls-files --others --exclude-standard | wc -l) ))
if [ "$changed_count" -gt "$MAX_CHANGED_FILES" ]; then
  echo "Error: Claude changed $changed_count files (max $MAX_CHANGED_FILES). This seems excessive."
  echo "Reverting all changes..."
  git checkout -- .
  git clean -fd
  exit 1
fi

# Collect all changes into one colored diff view
diff_review=$(
  git --no-pager diff --color=always
  git --no-pager diff --cached --color=always
  for f in $(git ls-files --others --exclude-standard); do
    printf '\e[1mnew file: %s\e[0m\n' "$f"
    printf '\e[32m%s\e[0m\n' "$(cat "$f")"
  done
)

echo "$diff_review" | less -R --prompt="Review changes (press q to continue)"
echo ""
read -rp "Accept these changes? [y/n] " answer

if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
  echo "Reverting changes..."
  git checkout -- .
  git clean -fd
  echo "Changes removed."
  exit 0
fi

# Stage everything
git add -A

# Generate commit message with Claude
echo "Generating commit message..."
diff_output=$(git --no-pager diff --cached)
commit_msg=$(claude -p "Write a concise git commit message (subject line + optional body) for these changes. Output ONLY the commit message, nothing else:\n\n$diff_output")

echo ""
echo "=== Commit Message ==="
echo "$commit_msg"
echo ""

git commit -m "$commit_msg"
echo "Committed."

echo ""
read -rp "Push to remote? [y/n] " push_answer

if [[ "$push_answer" == "y" || "$push_answer" == "Y" ]]; then
  branch=$(git branch --show-current)
  git push origin "$branch"
  echo "Pushed to origin/$branch."
else
  echo "Not pushed."
fi
